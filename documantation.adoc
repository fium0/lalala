== 4.2.1. Отправка уведомления через email

=== User Story

* Как тимлид, я хочу получать уведомления о том, что новый навык был отправлен на ревью, чтобы я мог своевременно его оценить и дать обратную связь.
* Как пользователь, я хочу получать уведомления, когда тимлид назначит мне новый навык, чтобы я знал, какой навык мне нужно развивать.

=== Таблица 1: Use Case 1 - Уведомление по email

[cols="1,2"]
|===
| Вариант использования | UC-1. Уведомление по email
| Действующие лица | Тимлид, Сотрудник, Система
| Предусловие | Настройки email-уведомлений включены, событие в Skill Matrix инициировано
| Постусловие (Гарантии успеха) | Email-уведомление отправлено пользователю
| Триггер | Возникновение события в SM
| Основной сценарий |
1. Событие инициируется в SM

2. Система формирует текст email-уведомления

3. Система отправляет уведомление на email пользователя

4. Система логирует факт отправки
| Альтернативные сценарии |
3a. Если отправка email завершается ошибкой:

* Система делает до 3 повторных попыток отправки с интервалом в 5 минут.

* Если все попытки завершаются ошибкой, система логирует ошибку.

3b. Если получение email-уведомлений у пользователя отключено:

* Система логирует событие, но уведомление не отправляет.
| Исключения |
1. Если сервер email недоступен:

* Система выводит сообщение об ошибке в логе.
|===

== 4.2.2. Отправка уведомления через push

=== User Story

* Как тимлид, я хочу получать уведомления о том, что новый навык был отправлен на ревью, чтобы я мог своевременно его оценить и дать обратную связь.
* Как пользователь, я хочу получать уведомления, когда тимлид назначит мне новый навык, чтобы я знал, какой навык мне нужно развивать.

=== Таблица 2: Use Case 2 - Уведомление через push

[cols="1,2"]
|===
| Вариант использования | UC-2. Уведомление через push
| Действующие лица | Тимлид, Сотрудник, Система
| Предусловие | Настройки push-уведомлений включены, событие в Skill Matrix инициировано
| Постусловие (Гарантии успеха) | Push-уведомление отправлено пользователю, отображено в колокольчике и помечено как прочитанное после взаимодействия пользователя
| Триггер | Возникновение события в SM
| Основной сценарий |
1. Событие инициируется в SM.

2. Система формирует текст push-уведомления.

3. Система отображает значок нового уведомления в колокольчике на панели пользователя.

4. Пользователь нажимает на колокольчик.

5. Система отображает список всех новых уведомлений.

6. Пользователь выбирает конкретное уведомление для прочтения.

7. Система отображает полный текст выбранного уведомления.

8. Система помечает уведомление как прочитанное.

9. Система логирует факт отправки, взаимодействия с уведомлением и его пометку как прочитанного.
| Альтернативные сценарии |
3a. Если отправка push завершается ошибкой:

* Система делает до 3 повторных попыток отправки с интервалом в 5 минут.

* Если все попытки завершаются ошибкой, система логирует ошибку.

3b. Если получение push-уведомлений у пользователя отключено:

* Система логирует событие, но уведомление не отправляет.

6a. Если пользователь выбирает опцию “Отметить все как прочитанные”:

* Система помечает все уведомления в списке как прочитанные.

* Система логирует факт взаимодействия и пометку всех уведомлений.
| Исключения |
1. Если сервер push недоступен:

* Система выводит сообщение об ошибке в логе.

2. Если пользователь нажимает на колокольчик, но уведомлений нет:

* Система отображает сообщение “У вас нет новых уведомлений”
|===

== 4.2.3. Настройка уведомлений

=== User Story

* Как пользователь (любой: обычный сотрудник, тимлид и др.), я хочу иметь возможность отключать уведомления, чтобы иметь контроль над тем, когда и какие уведомления мне приходят (отказаться от всех, либо не отказываться ни от каких).
* Как пользователь, я хочу по умолчанию получать все уведомления, если я не отключил определенные уведомления, чтобы иметь гарантию, что я получу информацию о событиях.

=== Таблица 3: Use Case 3 - Настройки уведомлений

[cols="1,2"]
|===
| Вариант использования | UC-3. Настройки уведомлений
| Действующие лица | Пользователь, Система
| Предусловие | Пользователь успешно аутентифицирован в системе.
| Постусловие (Гарантии успеха) | Пользователь настраивает уведомления по своему усмотрению
| Триггер | Пользователь заходит в настройки уведомлений
| Основной сценарий |
1. Пользователь заходит в раздел “Настройки уведомлений”

2. Пользователь изменяет настройки:

* Включение/выключение всех уведомлений

* Настройка каналов (email, push)

* Настройка типов событий

3. Пользователь сохраняет настройки

4. Система применяет изменения и логирует настройки.
| Особые требования |
* Изменения должны применяться немедленно
* Перед изменением настроек пользователь должен пройти аутентификацию
| Альтернативные сценарии |
2a. Если пользователь не выбрал ни одного типа уведомлений:

* Система отображает сообщение: “Все уведомления полностью отключены.”

3a. Если изменения не удалось применить из-за сбоя:

* Система отображает сообщение об ошибке и предлагает повторить попытку позже
| Исключения |
1. Если сервер недоступен:

* Система фиксирует ошибку, уведомляет пользователя о невозможности применить настройки и предлагает повторить попытку позже
|===

== 5.1. Создание и отправка уведомления

=== 5.1.1. Метод + путь
`POST /api/v1/notifications`

=== 5.1.2. Запрос/ответ

ЗАПРОС:
[source,json]
----
POST /api/v1/notifications
Authorization: Bearer <token>

{
  "name": "...",
  "description": "...",
  "sender_id": 11,
  "receiver_id": 15,
  "channel_id": 1
}
----

ОТВЕТ:
[source,json]
----
{
  "notification_id": 111
}
----

=== 5.1.3. Входные параметры

[options="header"]
|===
| № | Параметр    | Тип данных  | Как передается | Описание | Варианты значений | Обязательность
| 1 | name        | varchar(100) | Body | Название уведомления | Любая строка | Да
| 2 | description | text        | Body | Описание уведомления | Любая строка | Нет
| 3 | sender_id   | char(36)    | Body | Отправитель уведомления (ID) | user_id (любого пользователя) | Да
| 4 | receiver_id | char(36)    | Body | Получатель уведомления (ID) | user_id (любого пользователя) | Да
| 5 | channel_id  | int         | Body | Канал отправки уведомления (ID) | `1` (email), `2` (push) | Да
|===

=== 5.1.4. Выходные параметры

[options="header"]
|===
| № | Параметр        | Тип данных | Описание | Варианты значений
| 1 | notification_id | char(36)   | ID уведомления | Уникальный ID
|===

=== 5.1.4.1. Положительный ответ

[options="header"]
|===
| Код | Описание
| 200 | Уведомление успешно отправлено
| 201 | Уведомление успешно создано
|===

=== 5.1.4.2. Ответ с ошибками

[options="header"]
|===
| Код | Описание
| 400 | Неверные входные данные (например, отсутствует обязательное поле)
| 401 | Пользователь не авторизован (неверный или отсутствующий токен)
| 403 | Пользователь не имеет прав на создание уведомления
| 404 | Получатель или канал не найден
| 500 | Внутренняя ошибка сервера
|===

== 5.2. Прочтение уведомления

=== 5.2.1. Метод + путь
`PATCH /api/v1/notifications/{notification_id}/read`

=== 5.2.2. Запрос/ответ

ЗАПРОС:
[source,json]
----
PATCH /api/v1/notifications/333/read
Authorization: Bearer <token>
----

ОТВЕТ:
[source,json]
----
{
  "notification_id": 333,
  "receiver_id": 25,
  "sender_id": 20,
  "channel_id": 1,
  "status_id": 3,
  "sent_at": "2025-01-28T12:10"
}
----

=== 5.2.3. Входные параметры

[options="header"]
|===
| № | Параметр         | Тип данных   | Как передается | Описание           | Варианты значений
| 1 | notification_id  | varchar(100) | Path           | ID уведомления     | Любой существующий ID уведомления
|===

=== 5.2.4. Выходные параметры

[options="header"]
|===
| № | Параметр        | Тип данных   | Описание                      | Варианты значений
| 1 | notification_id | char(36)     | ID уведомления                | Любой существующий notification_id
| 2 | name           | varchar(100) | Название уведомления           | Любая строка
| 3 | description    | text         | Описание уведомления           | Любая строка
| 4 | receiver_id    | char(36)     | ID получателя уведомления      | user_id (любого пользователя)
| 5 | sender_id      | char(36)     | ID отправителя уведомления     | user_id (любого пользователя)
| 6 | channel_id     | int          | ID канала отправки уведомления | `1` (email), `2` (push)
| 7 | status_id      | int          | Новый статус уведомления       | 3 (прочитано)
| 8 | sent_at        | timestamptz  | Дата и время отправки уведомления | Любые корректные дата и время
|===

=== 5.2.4.1. Положительный ответ

[options="header"]
|===
| Код | Описание
| 200 | Уведомление успешно прочитано
|===

=== 5.2.4.2. Ответ с ошибками

[options="header"]
|===
| Код | Описание
| 401 | Пользователь не авторизован (неверный или отсутствующий токен)
| 403 | Пользователь не имеет прав на прочтение уведомления
| 404 | Уведомление с указанным ID не найдено
| 500 | Внутренняя ошибка сервера
|===

== Модель базы данных

[plantuml, db-diagram, svg]
----
@startuml
entity "users" {
  * user_id : char(36) <<PK>>
  * name : VARCHAR(100)
  * email : VARCHAR(200) <<UNIQUE>>
  * role : VARCHAR(150)
}

entity "notifications" {
  * notification_id : char(36) <<PK>>
  * name : VARCHAR(100)
  * description : TEXT
}

entity "notification_channels" {
  * channel_id : INT <<PK>>
  * name : VARCHAR(50)
}

entity "notification_status" {
  * status_id : INT <<PK>>
  * status_name : VARCHAR(50)
}

entity "user_notification_settings" {
  * setting_id : INT <<PK>>
  * user_id : INT <<FK>>
  * preferred_channel : VARCHAR(50)
}

entity "notification_log_data" {
  * log_id : char(36) <<PK>>
  * sender_id : char(36) <<FK>>
  * receiver_id : char(36) <<FK>>
  * notification_id : char(36) <<FK>>
  * channel_id : INT <<FK>>
  * status_id : INT <<FK>>
  * sent_at : timestamptz
}

' Связи между сущностями
users -- user_notification_settings : "1:1"
users -- notification_log_data : "1:M"
notifications -- notification_log_data : "1:M"
notification_channels -- notification_log_data : "1:M"
notification_status -- notification_log_data : "1:M"

@enduml
----
